rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /roadmaps/{roadmapId} {
        // Helper functions
        function isAuthenticated() {
            return request.auth != null;
        }

        function isOwner() {
            return isAuthenticated() && request.auth.uid == resource.data.userId;
        }

        function isOwnerCreate() {
            return isAuthenticated() && request.auth.uid == request.resource.data.userId;
        }

        // Read: Public roadmaps or owned roadmaps
        allow read: if (resource.data.public == true) || isOwner();

        // Create: Must be authenticated and set userId to own uid
        allow create: if isOwnerCreate();

        // Update: Must be owner and preserve ownership (userId cannot receive updates)
        allow update: if isOwner() && request.resource.data.userId == resource.data.userId;

        // Delete: Must be owner
        allow delete: if isOwner();
    }
  }
}
